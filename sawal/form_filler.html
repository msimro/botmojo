<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Conversational Form Filler</title>
    <style> /* Basic chat styles */
        body { font-family: sans-serif; max-width: 600px; margin: 2em auto; }
        #chat-window { border: 1px solid #ccc; height: 400px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
        .user-msg, .ai-msg { padding: 8px; border-radius: 8px; margin-bottom: 8px; max-width: 80%; }
        .user-msg { background-color: #007aff; color: white; margin-left: auto; }
        .ai-msg { background-color: #e5e5ea; color: black; }
        #chat-form { display: flex; }
        input { flex-grow: 1; padding: 10px; }
    </style>
</head>
<body>
    <h1>Conversational Form Filler</h1>
    <p>Let's start the "New Client Onboarding" process.</p>
    <div id="chat-window"></div>
    <form id="chat-form">
        <input type="text" id="user-input" autocomplete="off" placeholder="Type your answer...">
        <button type="submit">Send</button>
    </form>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        let conversationState = null; // Our state object

        async function postTurn(answer) {
            appendMessage('user', answer);
            userInput.value = '';
            
            const response = await fetch('api_form_filler.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    form_name: 'new_client_onboarding', // This initiates the form
                    state: conversationState,
                    answer: answer
                })
            });

            const newState = await response.json();
            conversationState = newState; // IMPORTANT: Update the state
            
            if (newState.next_prompt) {
                appendMessage('ai', newState.next_prompt);
            }
            if (newState.is_terminated) {
                userInput.disabled = true;
            }
        }

        function appendMessage(sender, text) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add(sender === 'user' ? 'user-msg' : 'ai-msg');
            msgDiv.textContent = text;
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight; // Auto-scroll
        }
        
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (message) {
                postTurn(message);
            }
        });

        // Start the conversation
        postTurn(''); 
    </script>
</body>
</html>